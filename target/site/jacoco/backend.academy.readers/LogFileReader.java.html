<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LogFileReader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java</a> &gt; <a href="index.source.html" class="el_package">backend.academy.readers</a> &gt; <span class="el_source">LogFileReader.java</span></div><h1>LogFileReader.java</h1><pre class="source lang-java linenums">package backend.academy.readers;

import backend.academy.nginx.NginxLog;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.InvalidPathException;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Objects;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.stream.Collectors;
import java.util.stream.Stream;
import static backend.academy.config.ErrorMessages.INVALID_FILEPATH_MESSAGE;
import static backend.academy.config.ErrorMessages.INVALID_FILE_READING_MESSAGE;

/**
 * Класс для чтения логов Nginx из файлов и директорий.
 *
 * &lt;p&gt;Этот класс наследует {@link AbstractLogReader} и реализует метод {@link #readLogs(List)}
 * для чтения логов из указанных файлов или директорий.
 * Поддерживает чтение только текстовых файлов с расширением .txt.&lt;/p&gt;
 */
<span class="nc" id="L30">public final class LogFileReader extends AbstractLogReader {</span>
<span class="nc" id="L31">    private static final Logger LOGGER = Logger.getLogger(LogFileReader.class.getName());</span>

    /**
     * Читает логи из указанных путей к файлам или директориям.
     *
     * &lt;p&gt;Метод обрабатывает каждый путь, проверяет его на валидность,
     * а затем читает логи из файлов или директорий, возвращая список объектов {@link NginxLog}.&lt;/p&gt;
     *
     * @param paths Список строк, представляющих пути к логам, которые необходимо прочитать.
     * @return Список объектов {@link NginxLog}, представляющих прочитанные логи.
     */
    @Override
    public List&lt;NginxLog&gt; readLogs(List&lt;String&gt; paths) {
<span class="nc" id="L44">        return paths.stream()</span>
<span class="nc" id="L45">            .map(this::resolveAndValidatePath)</span>
<span class="nc" id="L46">            .filter(Objects::nonNull)</span>
<span class="nc" id="L47">            .flatMap(this::processFileOrDirectory)</span>
<span class="nc" id="L48">            .collect(Collectors.toList());</span>
    }

    /**
     * Проверяет и нормализует указанный путь к файлу или директории.
     *
     * &lt;p&gt;Если путь недействителен, будет записано предупреждение в журнал.&lt;/p&gt;
     *
     * @param path Строка, представляющая путь к файлу или директории.
     * @return Нормализованный путь в виде {@link Path}, или null, если путь недействителен.
     */
    private Path resolveAndValidatePath(String path) {
        try {
<span class="nc" id="L61">            return Paths.get(path).toAbsolutePath().normalize();</span>
<span class="nc" id="L62">        } catch (InvalidPathException e) {</span>
<span class="nc" id="L63">            LOGGER.log(Level.WARNING, INVALID_FILEPATH_MESSAGE + path, e);</span>
<span class="nc" id="L64">            return null;</span>
        }
    }

    /**
     * Обрабатывает файл или директорию, возвращая поток объектов {@link NginxLog}.
     *
     * &lt;p&gt;Если указанный путь является директорией, метод ищет текстовые файлы и читает их.
     * Если путь указывает на файл, он будет прочитан непосредственно.&lt;/p&gt;
     *
     * @param path Нормализованный путь к файлу или директории.
     * @return Поток объектов {@link NginxLog}, полученных из файлов.
     */
    private Stream&lt;NginxLog&gt; processFileOrDirectory(Path path) {
<span class="nc" id="L78">        File fileOrDir = path.toFile();</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">        if (!fileOrDir.exists()) {</span>
<span class="nc" id="L80">            LOGGER.log(Level.SEVERE, INVALID_FILEPATH_MESSAGE + path);</span>
<span class="nc" id="L81">            return Stream.empty();</span>
        }

<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (fileOrDir.isDirectory()) {</span>
<span class="nc bnc" id="L85" title="All 4 branches missed.">            File[] logFiles = fileOrDir.listFiles(file -&gt; file.isFile() &amp;&amp; file.getName().endsWith(&quot;.txt&quot;));</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            return (logFiles != null) ? Arrays.stream(logFiles).flatMap(this::readFile) : Stream.empty();</span>
        } else {
<span class="nc" id="L88">            return readFile(fileOrDir);</span>
        }
    }

    /**
     * Читает содержимое указанного файла и преобразует его строки в объекты {@link NginxLog}.
     *
     * &lt;p&gt;Если возникает ошибка при чтении файла, будет записано предупреждение в журнал.&lt;/p&gt;
     *
     * @param file Файл, который необходимо прочитать.
     * @return Поток объектов {@link NginxLog}, полученных из файла.
     */
    private Stream&lt;NginxLog&gt; readFile(File file) {
<span class="nc" id="L101">        List&lt;NginxLog&gt; nginxLogs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L102">        try (BufferedReader reader = new BufferedReader(new FileReader(file, StandardCharsets.UTF_8))) {</span>
            String line;
<span class="nc bnc" id="L104" title="All 2 branches missed.">            while ((line = reader.readLine()) != null) {</span>
<span class="nc" id="L105">                nginxLogs.add(convertLineToNginx(line));</span>
            }
<span class="nc" id="L107">        } catch (IOException e) {</span>
<span class="nc" id="L108">            LOGGER.log(Level.WARNING, INVALID_FILE_READING_MESSAGE + file.getAbsolutePath(), e);</span>
<span class="nc" id="L109">        }</span>
<span class="nc" id="L110">        return nginxLogs.stream();</span>
    }
}





</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>